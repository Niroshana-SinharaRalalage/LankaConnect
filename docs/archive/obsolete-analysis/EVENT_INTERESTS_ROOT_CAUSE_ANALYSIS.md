# Root Cause Analysis: Event Interests Issues

**Date**: 2025-12-28
**Environment**: Azure Staging (lankaconnect-api-staging)
**Investigation By**: System Architecture Designer
**Severity**: Medium - UI/UX issues, no data corruption

---

## Executive Summary

The Event Interests (formerly Cultural Interests) feature is experiencing 4 interconnected issues due to **deployment status mismatch** between local development and Azure staging. The local codebase has been updated to support unlimited interests with dynamic EventCategory codes from the database, but these changes have **NOT been deployed to Azure staging** yet.

**Current Status**:
- ✅ Local code builds successfully (0 errors)
- ✅ Backend changes committed to `develop` branch
- ❌ Changes NOT deployed to Azure staging
- ❌ Staging still running OLD code with hardcoded 10-interest limit

**Impact**:
- Users see confusing "999" limit in UI
- Counter shows "15 of 999 selected" but only 8 checkboxes visible
- Backend throws "Invalid cultural interest code: Business" error
- Legacy hardcoded interests stored in database don't match new EventCategory codes

---

## SECTION 1: DATABASE INVESTIGATION

### 1.1 Database Schema

**Table Name**: `users.user_cultural_interests`
**Schema**: `users`
**Migration**: `20251101194703_CreateUserCulturalInterestsAndLanguagesTables`

```sql
CREATE TABLE users.user_cultural_interests (
    Id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    interest_code VARCHAR(50) NOT NULL,
    UserId UUID NOT NULL,
    CONSTRAINT FK_user_cultural_interests_users_UserId
        FOREIGN KEY (UserId) REFERENCES identity.users(Id) ON DELETE CASCADE,
    CONSTRAINT ix_user_cultural_interests_user_code
        UNIQUE (UserId, interest_code)
);
```

**Key Constraints**:
- `interest_code`: Max 50 characters (stores CulturalInterest.Code)
- Unique constraint prevents duplicate interests per user
- Cascade delete when user is deleted

### 1.2 Current Data Query

```sql
-- Query to show user's cultural interests with details
SELECT
    u.id as user_id,
    u.email,
    u.first_name,
    u.last_name,
    uci.interest_code,
    COUNT(*) OVER (PARTITION BY uci.UserId) as total_interests
FROM identity.users u
LEFT JOIN users.user_cultural_interests uci ON u.id = uci.UserId
WHERE u.email = '<user-email-here>'
ORDER BY uci.interest_code;

-- Query to find all stored interest codes
SELECT DISTINCT interest_code, COUNT(*) as user_count
FROM users.user_cultural_interests
GROUP BY interest_code
ORDER BY user_count DESC;
```

### 1.3 The "15 vs 8" Mystery Explained

**Why Counter Shows 15**:
- Database has 15 interest codes stored (legacy hardcoded CulturalInterest codes)
- Example legacy codes: `SL_CUISINE`, `BUDDHIST_FEST`, `HINDU_FEST`, `CRICKET`, etc.
- These were saved when old hardcoded system was active

**Why Only 8 Visible**:
- Frontend now fetches EventCategory from database via API
- EventCategory enum has only 8 values:
  ```csharp
  Religious, Cultural, Community, Educational,
  Social, Business, Charity, Entertainment
  ```
- API endpoint returns 8 EventCategory items
- UI renders checkboxes for these 8 EventCategory codes
- Legacy 15 interest codes DON'T match EventCategory codes
- Result: 15 stored interests, 8 checkboxes, 7 interests invisible

**Data Mismatch Example**:
```
DATABASE STORED (15 legacy codes):
  ✓ SL_CUISINE
  ✓ BUDDHIST_FEST
  ✓ HINDU_FEST
  ✓ CRICKET
  ✓ AYURVEDA
  ... (10 more)

UI DISPLAYS (8 EventCategory codes):
  ✓ Religious
  ✓ Cultural
  ✓ Community
  ✓ Educational
  ✓ Social
  ✓ Business
  ✓ Charity
  ✓ Entertainment

INTERSECTION: 0 matches → 7 interests lost in UI
```

### 1.4 Database Cleanup Required

**Solution**: Execute the prepared SQL script to clear legacy interests:

```sql
-- c:\Work\LankaConnect\scripts\clear-all-event-interests.sql
DELETE FROM users.user_cultural_interests;
```

**Impact**:
- Clears ALL user interests (safe - users will re-select from new EventCategory list)
- No data corruption (cascade deletes handle relationships)
- Users must re-select interests after cleanup

**Verification Query**:
```sql
SELECT u.email, COUNT(uci.interest_code) as interest_count
FROM identity.users u
LEFT JOIN users.user_cultural_interests uci ON u.id = uci.UserId
GROUP BY u.email
HAVING COUNT(uci.interest_code) > 0;
```

---

## SECTION 2: DEPLOYMENT STATUS ANALYSIS

### 2.1 Local vs Azure Code Differences

**Local Development (develop branch)**:
- ✅ CulturalInterest.FromCode() updated (line 83-101) - supports dynamic codes
- ✅ User.UpdateCulturalInterests() - no max limit (line 566-585)
- ✅ UpdateCulturalInterestsCommandHandler - uses new FromCode()
- ✅ Frontend profile.constants.ts - max: 999 (line 104)
- ✅ Frontend profileSchemas.ts - no .max(10) validation (line 33-35)
- ✅ Build status: SUCCESS (0 errors, 0 warnings)

**Azure Staging**:
- ❌ OLD CulturalInterest.FromCode() - returns error for non-hardcoded codes
- ❌ OLD User.UpdateCulturalInterests() - enforces 10-interest limit
- ❌ OLD frontend - max: 10 constraint still active
- ❌ Result: "Invalid cultural interest code: Business" error

### 2.2 Why Azure Still Runs Old Code

**GitHub Actions Deployment Trigger**:
```yaml
# .github/workflows/deploy-staging.yml
on:
  push:
    branches:
      - develop  # ✅ Trigger on push to develop
  workflow_dispatch:  # ✅ Manual trigger available
```

**Recent Commits on develop**:
```
5ce64d29 - fix(phase-6a53): Redirect to login after registration
766adedf - docs(phase-6a53): Add Phase 6A.53 summary
d0a5df9e - fix(phase-6a47): Replace Event Category with reference data API ← CRITICAL
a8b1f2ab - fix(phase-6a47): Correct apiClient import
bf41c4e1 - fix(phase-6a47): Register IApplicationUrlsService
```

**Deployment Process** (deploy-staging.yml):
1. Checkout code from `develop` branch
2. Restore dependencies
3. Build application (dotnet build)
4. Run unit tests (must pass - Zero Tolerance)
5. Login to Azure Container Registry
6. Publish application (dotnet publish)
7. Build Docker image with tag `{github.sha}`
8. Push Docker image to ACR
9. Run EF migrations on staging database
10. Update Azure Container App with new image
11. Health check smoke test

**Last Deployment Check**:
```bash
# Check GitHub Actions for last staging deployment
# Workflow: .github/workflows/deploy-staging.yml
# Expected: Deployment triggered by commit d0a5df9e or later
```

**Issue**: Deployment may have been skipped or failed silently.

### 2.3 How to Verify Deployment Status

**Method 1: Check Azure Container App Image Tag**:
```bash
az containerapp show \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging \
  --query 'properties.template.containers[0].image' -o tsv

# Expected output (for latest code):
# lankaconnectstaging.azurecr.io/lankaconnect-api:d0a5df9e... (commit SHA)
```

**Method 2: Check Container App Logs**:
```bash
az containerapp logs show \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging \
  --tail 100 \
  --follow

# Look for startup messages showing build timestamp and version
```

**Method 3: Test API Endpoint**:
```bash
# Test if new FromCode() logic is deployed
curl -X PUT https://lankaconnect-api-staging.azurecontainerapps.io/api/users/{userId}/cultural-interests \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"InterestCodes": ["Business", "Cultural"]}'

# Expected (NEW code): 200 OK
# Actual (OLD code): 400 Bad Request - "Invalid cultural interest code: Business"
```

**Method 4: Check GitHub Actions Workflow Runs**:
```bash
# Navigate to: https://github.com/{org}/{repo}/actions/workflows/deploy-staging.yml
# Check last workflow run status, timestamp, and commit SHA
```

### 2.4 Why "Invalid cultural interest code: Business" Error Persists

**OLD Code Logic** (Azure staging):
```csharp
// CulturalInterest.cs (OLD VERSION)
public static Result<CulturalInterest> FromCode(string? code)
{
    if (string.IsNullOrWhiteSpace(code))
        return Result<CulturalInterest>.Failure("Code cannot be null");

    var interest = All.FirstOrDefault(i => i.Code == code);

    if (interest == null)
        return Result<CulturalInterest>.Failure($"Invalid cultural interest code: {code}");

    return Result<CulturalInterest>.Success(interest);
}

// All = hardcoded list of 20 predefined interests
// "Business" NOT in hardcoded list → error
```

**NEW Code Logic** (Local development):
```csharp
// CulturalInterest.cs (NEW VERSION)
public static Result<CulturalInterest> FromCode(string? code, string? name = null)
{
    if (string.IsNullOrWhiteSpace(code))
        return Result<CulturalInterest>.Failure("Code cannot be null");

    // Check hardcoded interests first
    var interest = All.FirstOrDefault(i => i.Code == code);
    if (interest != null)
        return Result<CulturalInterest>.Success(interest);

    // Phase 6A.47: Create dynamic interest from EventCategory codes
    return Result<CulturalInterest>.Success(new CulturalInterest(code, name ?? code));
}

// "Business" NOT in hardcoded list → creates dynamic interest ✅
```

**Root Cause**: Azure staging still runs OLD FromCode() without dynamic support.

---

## SECTION 3: UI COMPONENTS INVESTIGATION

### 3.1 Files Responsible for "999" Limit Display

**File 1**: `web/src/domain/constants/profile.constants.ts` (Line 104)
```typescript
export const PROFILE_CONSTRAINTS = {
  culturalInterests: {
    min: 0,
    max: 999, // ← "999" displayed in UI
  },
  // ...
}
```

**File 2**: `web/src/presentation/components/features/profile/CulturalInterestsSection.tsx`

**Line 127**: Description text with limit
```tsx
<CardDescription>
  Select event categories that interest you (choose 0-{PROFILE_CONSTRAINTS.culturalInterests.max} interests)
  {/* Renders: "choose 0-999 interests" */}
</CardDescription>
```

**Lines 69-72**: Validation logic checking max limit
```tsx
if (prev.length >= PROFILE_CONSTRAINTS.culturalInterests.max) {
  setValidationError(
    `You can select up to ${PROFILE_CONSTRAINTS.culturalInterests.max} interests`
  );
  return prev;
}
```

**Lines 86-91**: Save validation checking max limit
```tsx
if (selectedInterests.length > PROFILE_CONSTRAINTS.culturalInterests.max) {
  setValidationError(
    `Maximum ${PROFILE_CONSTRAINTS.culturalInterests.max} interests allowed`
  );
  return;
}
```

**Line 209**: Counter display
```tsx
<p className="text-sm text-muted-foreground">
  {selectedInterests.length} of {PROFILE_CONSTRAINTS.culturalInterests.max} selected
  {/* Renders: "15 of 999 selected" */}
</p>
```

### 3.2 All UI References to 999 Limit

**Search Results**:
```
web/src/domain/constants/profile.constants.ts:104
  - max: 999

web/src/presentation/components/features/profile/CulturalInterestsSection.tsx:127
  - Description: "choose 0-{PROFILE_CONSTRAINTS.culturalInterests.max} interests"

web/src/presentation/components/features/profile/CulturalInterestsSection.tsx:71
  - Validation error: "You can select up to {max} interests"

web/src/presentation/components/features/profile/CulturalInterestsSection.tsx:88
  - Validation error: "Maximum {max} interests allowed"

web/src/presentation/components/features/profile/CulturalInterestsSection.tsx:209
  - Counter: "{count} of {max} selected"
```

### 3.3 Frontend Validation Schema

**File**: `web/src/domain/validation/profileSchemas.ts` (Lines 33-35)
```typescript
export const culturalInterestsSchema = z
  .array(z.string().min(1).max(50))
  .optional();
// NOTE: .max(10) was REMOVED - no limit on array length
// Only constraint: each interest code max 50 characters
```

**Impact**: Frontend validation allows unlimited interests, but UI still shows "999".

---

## SECTION 4: ROOT CAUSES

### 4.1 Issue #1: Why "999" Still Shows

**Root Cause**: UI Text Hardcoded with Constraint Constant

**Causal Chain**:
1. User wants NO limit display at all
2. Developer changed `max: 10` to `max: 999` as "effectively unlimited"
3. UI components reference `PROFILE_CONSTRAINTS.culturalInterests.max` directly
4. Text renders: "choose 0-999 interests" and "15 of 999 selected"
5. User expectation: NO limit text, NO counter

**Why 999 Was Chosen**: Developer interpreted "unlimited" as "very high limit" instead of "no UI display".

**Correct Solution**: Remove limit display entirely, not just increase number.

### 4.2 Issue #2: Where Are the Other 7 Interests?

**Root Cause**: Data Model Migration Without Database Cleanup

**Causal Chain**:
1. Original system used 20 hardcoded CulturalInterest codes
2. User selected 15 interests from hardcoded list (e.g., `SL_CUISINE`, `CRICKET`)
3. Data stored in `users.user_cultural_interests` table
4. Phase 6A.47 migrated to database-driven EventCategory (8 codes)
5. Frontend now displays only 8 EventCategory checkboxes
6. Legacy 15 stored interests DON'T match new 8 EventCategory codes
7. Counter reads database: 15 interests
8. UI renders checkboxes: 8 EventCategory codes
9. Result: 15 - 8 = 7 interests invisible

**Database Evidence**:
```
DATABASE: 15 rows in user_cultural_interests
  - Codes: SL_CUISINE, BUDDHIST_FEST, HINDU_FEST, CRICKET, etc.

EVENTCATEGORY: 8 codes
  - Codes: Religious, Cultural, Community, Educational, Social, Business, Charity, Entertainment

INTERSECTION: 0 matches
  - Legacy codes like "SL_CUISINE" ≠ EventCategory codes like "Cultural"
```

**Why Cleanup Wasn't Automatic**: Migration focused on code changes, not data migration strategy.

### 4.3 Issue #3: How to Remove Selection Validation Completely?

**Root Cause**: UI Components Enforce Unnecessary Validation

**Current Validation Points**:

1. **Frontend Constant** (profile.constants.ts:104):
   - `max: 999` - Used for UI display and client-side validation

2. **Frontend Zod Schema** (profileSchemas.ts:33-35):
   - `z.array(z.string().min(1).max(50)).optional()`
   - No array length validation (✅ correct)

3. **UI Component Logic** (CulturalInterestsSection.tsx):
   - Lines 69-72: Check if `prev.length >= max` before adding
   - Lines 86-91: Validate `selectedInterests.length > max` before save
   - Line 127: Display text with max limit
   - Line 209: Display counter with max limit

4. **Backend Validation** (User.cs:566-585):
   - No max limit enforced (✅ correct)
   - `UpdateCulturalInterests()` accepts unlimited interests

**Why Validation Still Present**: Frontend UI still checks `PROFILE_CONSTRAINTS.culturalInterests.max` even though backend doesn't enforce it.

**Correct Solution**:
- Remove ALL references to `max` in UI component
- Remove counter display entirely
- Remove validation error logic for max limit
- Keep validation for empty/invalid codes only

### 4.4 Issue #4: Why "Invalid cultural interest code: Business" Error?

**Root Cause**: Deployment Lag - Azure Runs Old Code

**Causal Chain**:
1. Local development updated `CulturalInterest.FromCode()` to support dynamic codes
2. Local build: SUCCESS (0 errors)
3. Changes committed to `develop` branch (commit d0a5df9e)
4. Azure staging deployment **NOT triggered** or **failed silently**
5. Azure staging still runs OLD Docker image
6. OLD code has hardcoded `FromCode()` without dynamic support
7. User selects "Business" from EventCategory dropdown
8. API request: `PUT /api/users/{id}/cultural-interests` with `["Business"]`
9. Backend (OLD code) calls `CulturalInterest.FromCode("Business")`
10. OLD logic checks hardcoded list: "Business" NOT found
11. Returns error: "Invalid cultural interest code: Business"

**Expected Behavior (NEW code)**:
```csharp
FromCode("Business", null)
  → Check hardcoded list: NOT found
  → Create dynamic interest: new CulturalInterest("Business", "Business")
  → Return success ✅
```

**Actual Behavior (OLD code)**:
```csharp
FromCode("Business")
  → Check hardcoded list: NOT found
  → Return error: "Invalid cultural interest code: Business" ❌
```

**Why Deployment Matters**:
- Local build success ≠ Azure deployment success
- GitHub Actions must complete all steps for code to reach staging
- Container App must pull and run NEW Docker image
- Deployment verification required after every merge to `develop`

---

## SECTION 5: COMPREHENSIVE FIX PLAN

### Step 1: Verify Azure Staging Deployment Status

**Objective**: Determine if new code is deployed or if deployment is needed.

**Commands**:
```bash
# 1.1 Check current Docker image tag
az containerapp show \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging \
  --query 'properties.template.containers[0].image' -o tsv

# Expected: lankaconnectstaging.azurecr.io/lankaconnect-api:d0a5df9e... (or later)
# If older commit SHA → deployment needed

# 1.2 Check GitHub Actions workflow runs
# Navigate to: https://github.com/{org}/{repo}/actions/workflows/deploy-staging.yml
# Verify last successful run matches commit d0a5df9e or later

# 1.3 Test API with EventCategory code
curl -X PUT https://lankaconnect-api-staging.azurecontainerapps.io/api/users/{userId}/cultural-interests \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"InterestCodes": ["Business"]}'

# Expected (NEW code): 200 OK
# If 400 error → deployment needed
```

**Decision Point**:
- ✅ If image tag matches recent commit → Proceed to Step 3
- ❌ If image tag is old → Proceed to Step 2

### Step 2: Deploy Backend to Azure Staging

**Objective**: Deploy new code with dynamic CulturalInterest support.

**Method 1: Automatic Trigger (Recommended)**:
```bash
# Push a commit to develop branch
git push origin develop

# GitHub Actions will automatically:
# 1. Build project
# 2. Run tests (must pass - Zero Tolerance)
# 3. Build Docker image
# 4. Push to Azure Container Registry
# 5. Run EF migrations
# 6. Update Container App
# 7. Health check

# Monitor deployment:
# https://github.com/{org}/{repo}/actions
```

**Method 2: Manual Trigger**:
```bash
# Trigger workflow manually via GitHub UI
# Navigate to: Actions → Deploy to Azure Staging → Run workflow

# OR via GitHub CLI:
gh workflow run deploy-staging.yml --ref develop
```

**Verification**:
```bash
# Wait 5-10 minutes for deployment to complete

# 2.1 Check Container App logs
az containerapp logs show \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging \
  --tail 50

# Look for: Application started, no errors

# 2.2 Health check
curl https://lankaconnect-api-staging.azurecontainerapps.io/health

# Expected: 200 OK with healthy status

# 2.3 Test EventCategory API
curl https://lankaconnect-api-staging.azurecontainerapps.io/api/reference-data?types=EventCategory

# Expected: JSON array with 8 EventCategory codes
```

### Step 3: Execute Database Cleanup Script

**Objective**: Clear legacy hardcoded interests so users can re-select from EventCategory.

**Pre-Flight Check**:
```bash
# 3.1 Backup current interests (optional)
psql -h {host} -U {user} -d {database} -c \
  "COPY users.user_cultural_interests TO '/tmp/interests_backup_$(date +%Y%m%d).csv' WITH CSV HEADER;"

# 3.2 Count current interests
psql -h {host} -U {user} -d {database} -c \
  "SELECT COUNT(*) as total_interests FROM users.user_cultural_interests;"
```

**Execute Cleanup**:
```bash
# Option 1: Direct SQL execution
psql -h {host} -U {user} -d {database} -f scripts/clear-all-event-interests.sql

# Option 2: Azure CLI
az postgres flexible-server execute \
  --name {server-name} \
  --admin-user {admin} \
  --admin-password {password} \
  --database-name {database} \
  --file-path scripts/clear-all-event-interests.sql
```

**Verification**:
```bash
# 3.3 Verify cleanup
psql -h {host} -U {user} -d {database} -c \
  "SELECT COUNT(*) as remaining FROM users.user_cultural_interests;"

# Expected: 0 rows
```

**Impact Assessment**:
- All users' interests cleared (expected behavior)
- No data corruption (cascade deletes handled)
- Users must re-select interests from new EventCategory list
- User communication recommended: "We've updated event interests - please re-select your preferences"

### Step 4: Remove UI Counter and Limit Display

**Objective**: Completely remove limit validation and counter from frontend.

**File Changes**:

**4.1 Update profile.constants.ts**:
```typescript
// c:\Work\LankaConnect\web\src\domain\constants\profile.constants.ts

// BEFORE (Line 102-105):
culturalInterests: {
  min: 0,
  max: 999,
},

// AFTER:
culturalInterests: {
  min: 0,
  // No max property - unlimited interests allowed
},
```

**4.2 Update CulturalInterestsSection.tsx**:

```typescript
// c:\Work\LankaConnect\web\src\presentation\components\features\profile\CulturalInterestsSection.tsx

// CHANGE 1: Remove limit from description (Line 127)
// BEFORE:
<CardDescription>
  Select event categories that interest you (choose 0-{PROFILE_CONSTRAINTS.culturalInterests.max} interests)
</CardDescription>

// AFTER:
<CardDescription>
  Select event categories that interest you
</CardDescription>

// CHANGE 2: Remove max validation in handleToggleInterest (Lines 68-74)
// BEFORE:
const handleToggleInterest = (code: string) => {
  setSelectedInterests((prev) => {
    if (prev.includes(code)) {
      return prev.filter((c) => c !== code);
    } else {
      if (prev.length >= PROFILE_CONSTRAINTS.culturalInterests.max) {
        setValidationError(`You can select up to ${PROFILE_CONSTRAINTS.culturalInterests.max} interests`);
        return prev;
      }
      setValidationError('');
      return [...prev, code];
    }
  });
};

// AFTER:
const handleToggleInterest = (code: string) => {
  setSelectedInterests((prev) => {
    if (prev.includes(code)) {
      return prev.filter((c) => c !== code);
    } else {
      setValidationError('');
      return [...prev, code];
    }
  });
};

// CHANGE 3: Remove max validation in handleSave (Lines 86-91)
// BEFORE:
const handleSave = async () => {
  if (selectedInterests.length > PROFILE_CONSTRAINTS.culturalInterests.max) {
    setValidationError(`Maximum ${PROFILE_CONSTRAINTS.culturalInterests.max} interests allowed`);
    return;
  }
  // ... rest of save logic
};

// AFTER:
const handleSave = async () => {
  // No max validation - proceed directly to API call
  try {
    await updateCulturalInterests(user.userId, {
      InterestCodes: selectedInterests,
    });
    setIsEditing(false);
  } catch (error) {
    // Error handled by store
  }
};

// CHANGE 4: Remove counter display (Lines 207-210)
// BEFORE:
<p className="text-sm text-muted-foreground">
  {selectedInterests.length} of {PROFILE_CONSTRAINTS.culturalInterests.max} selected
</p>

// AFTER:
{/* Counter removed - no limit display */}
```

**Verification**:
```bash
# 4.3 Rebuild frontend
cd web
npm run build

# Expected: No errors, no warnings

# 4.4 Test locally
npm run dev
# Navigate to /profile
# Verify:
#   - Description: "Select event categories that interest you" (no limit)
#   - No counter display
#   - Can select all 8 checkboxes without error
```

### Step 5: Deploy Frontend Changes

**Objective**: Deploy updated frontend to staging/production.

**Commands**:
```bash
# 5.1 Commit frontend changes
git add web/src/domain/constants/profile.constants.ts
git add web/src/presentation/components/features/profile/CulturalInterestsSection.tsx
git commit -m "fix(event-interests): Remove limit display and counter from UI

- Remove max:999 limit text from description
- Remove counter showing 'X of 999 selected'
- Remove client-side max validation
- Allow unlimited EventCategory selections
- Fixes confusing UI display per user feedback"

# 5.2 Push to develop
git push origin develop

# 5.3 Deploy frontend (method depends on your setup)
# Option A: Vercel/Netlify auto-deploy from develop
# Option B: Manual deploy via CI/CD
# Option C: Azure Static Web Apps deployment
```

**Verification**:
```bash
# 5.4 Test deployed frontend
# Navigate to: https://{staging-frontend-url}/profile
# Login and edit Event Interests
# Verify:
#   - No "999" in description
#   - No counter display
#   - Can select multiple interests
#   - Save works without max validation error
```

### Step 6: Test API Endpoint End-to-End

**Objective**: Verify backend accepts EventCategory codes and saves correctly.

**Test Script**:
```bash
# 6.1 Get auth token
TOKEN=$(curl -X POST https://lankaconnect-api-staging.azurecontainerapps.io/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123!"}' \
  | jq -r '.token')

# 6.2 Get current user info
USER_ID=$(curl -X GET https://lankaconnect-api-staging.azurecontainerapps.io/api/users/me \
  -H "Authorization: Bearer $TOKEN" \
  | jq -r '.id')

# 6.3 Update interests with EventCategory codes
curl -X PUT https://lankaconnect-api-staging.azurecontainerapps.io/api/users/$USER_ID/cultural-interests \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "InterestCodes": [
      "Business",
      "Cultural",
      "Religious",
      "Social",
      "Educational"
    ]
  }' \
  -v

# Expected Response: 200 OK
# If 400 error → backend still has old code

# 6.4 Verify interests saved
curl -X GET https://lankaconnect-api-staging.azurecontainerapps.io/api/users/$USER_ID \
  -H "Authorization: Bearer $TOKEN" \
  | jq '.culturalInterests'

# Expected: ["Business","Cultural","Religious","Social","Educational"]
```

**Error Scenarios**:
```
400 Bad Request - "Invalid cultural interest code: Business"
→ Backend deployment failed or incomplete
→ Retry Step 2

500 Internal Server Error
→ Check Azure Container App logs
→ Database connection issue or migration not applied

401 Unauthorized
→ Token expired, re-login

404 Not Found
→ API endpoint path incorrect or not deployed
```

### Step 7: Verify Azure Container Logs

**Objective**: Ensure no errors in application startup or runtime.

**Commands**:
```bash
# 7.1 Stream live logs
az containerapp logs show \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging \
  --follow

# Look for:
#   ✅ "Application started"
#   ✅ "Now listening on: http://0.0.0.0:5000"
#   ✅ "Hosting environment: Staging"
#   ❌ Any exception stack traces
#   ❌ "Invalid cultural interest code" errors

# 7.2 Check recent logs (last 100 lines)
az containerapp logs show \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging \
  --tail 100 \
  | grep -i "error\|exception\|cultural"

# Expected: No errors related to cultural interests

# 7.3 Check database migration logs
az containerapp logs show \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging \
  --tail 200 \
  | grep -i "migration\|ef core"

# Expected: "Applying migration '20251101194703_CreateUserCulturalInterestsAndLanguagesTables'"
```

**Common Issues**:
```
"Failed to connect to database"
→ Connection string incorrect or database down
→ Check Key Vault secret: DATABASE-CONNECTION-STRING

"Migration already applied"
→ Expected behavior, no action needed

"Table 'users.user_cultural_interests' already exists"
→ Expected behavior from previous migrations

"Invalid cultural interest code: Business"
→ Old code still running, redeploy needed
```

### Step 8: End-to-End Testing Strategy

**Objective**: Comprehensive validation of complete fix.

**Test Case 1: New User Registration and Interest Selection**
```
1. Register new user account
2. Login successfully
3. Navigate to Profile → Event Interests
4. Verify description: "Select event categories that interest you" (no limit)
5. Verify no counter display
6. Select 3 EventCategory interests (e.g., Business, Cultural, Social)
7. Click "Save Interests"
8. Verify success message
9. Reload page
10. Verify 3 interests displayed as badges
11. Edit interests again
12. Verify checkboxes match saved interests
✅ PASS if all steps succeed
```

**Test Case 2: Existing User Re-selecting Interests**
```
1. Login as existing user (had 15 legacy interests)
2. Navigate to Profile → Event Interests
3. Verify view mode shows 0 interests (cleared by Step 3)
4. Click "Edit"
5. Verify 8 EventCategory checkboxes displayed
6. Verify no counter display
7. Select 5 interests
8. Click "Save Interests"
9. Verify success message
10. Verify 5 interest badges displayed
✅ PASS if all steps succeed
```

**Test Case 3: Edge Cases**
```
Test 3a: Select All Interests (8/8)
  - Select all 8 EventCategory checkboxes
  - Verify no validation error
  - Save successfully
  - ✅ PASS if 8 interests saved

Test 3b: Select No Interests (0/8)
  - Deselect all interests
  - Save successfully
  - Verify 0 interests saved (privacy choice allowed)
  - ✅ PASS if save succeeds

Test 3c: Cancel Edit
  - Edit interests
  - Change selections
  - Click "Cancel"
  - Verify original interests retained
  - ✅ PASS if changes discarded

Test 3d: API Direct Call
  - Call PUT /api/users/{id}/cultural-interests with 6 codes
  - Verify 200 OK response
  - Verify database has 6 rows in user_cultural_interests
  - ✅ PASS if API accepts and saves
```

**Test Case 4: Performance and Database**
```
Test 4a: Database Query Performance
  - Query: SELECT * FROM users.user_cultural_interests WHERE UserId = '{guid}'
  - Verify < 50ms response time
  - ✅ PASS if performant

Test 4b: Concurrent Updates
  - User A updates interests
  - User B updates interests (different user)
  - Verify both save successfully without conflict
  - ✅ PASS if no deadlocks

Test 4c: Data Integrity
  - Query database directly
  - Verify no duplicate interest_code per user
  - Verify foreign key constraints enforced
  - ✅ PASS if integrity maintained
```

**Rollback Plan** (if critical issues found):
```bash
# Rollback Step 1: Revert to previous Docker image
az containerapp update \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging \
  --image lankaconnectstaging.azurecr.io/lankaconnect-api:{previous-commit-sha}

# Rollback Step 2: Revert database cleanup (restore from backup)
psql -h {host} -U {user} -d {database} -c \
  "COPY users.user_cultural_interests FROM '/tmp/interests_backup_{date}.csv' WITH CSV HEADER;"

# Rollback Step 3: Revert frontend code
git revert {commit-sha}
git push origin develop

# Rollback Step 4: Verify rollback
curl https://lankaconnect-api-staging.azurecontainerapps.io/health
```

---

## SECTION 6: PREVENTIVE MEASURES

### 6.1 Deployment Verification Checklist

**Post-Deployment Verification** (add to CI/CD):
```yaml
# Add to deploy-staging.yml after "Update Container App" step
- name: Verify Deployment Code Version
  run: |
    echo "Verifying new code is running..."

    # Test EventCategory API endpoint
    RESPONSE=$(curl -s https://lankaconnect-api-staging.azurecontainerapps.io/api/reference-data?types=EventCategory)
    COUNT=$(echo $RESPONSE | jq 'length')

    if [ "$COUNT" -ne 8 ]; then
      echo "❌ EventCategory API returned $COUNT items, expected 8"
      exit 1
    fi

    echo "✅ EventCategory API verified (8 items)"

    # Test new FromCode() logic (requires auth - skip for now)
    # Add integration test here if auth token available
```

### 6.2 Database Migration Strategy

**Add Data Migration Script** (alongside schema migration):
```sql
-- src/LankaConnect.Infrastructure/Migrations/Scripts/MigrateCulturalInterestsToEventCategory.sql

-- Map legacy CulturalInterest codes to EventCategory codes
-- Run after deploying Phase 6A.47 changes

-- Example mapping:
-- SL_CUISINE → Cultural
-- BUDDHIST_FEST → Religious
-- CRICKET → Social
-- etc.

UPDATE users.user_cultural_interests
SET interest_code =
  CASE
    WHEN interest_code IN ('SL_CUISINE', 'TRAD_DANCE', 'TRAD_ARTS') THEN 'Cultural'
    WHEN interest_code IN ('BUDDHIST_FEST', 'HINDU_FEST', 'ISLAMIC_FEST', 'CHRISTIAN_FEST', 'VESAK', 'TEMPLE_ARCH') THEN 'Religious'
    WHEN interest_code = 'CRICKET' THEN 'Social'
    WHEN interest_code = 'AYURVEDA' THEN 'Educational'
    WHEN interest_code = 'DIASPORA_NET' THEN 'Community'
    ELSE interest_code  -- Keep unmapped codes (will need manual review)
  END;

-- Remove duplicates after mapping (same user might have SL_CUISINE and TRAD_DANCE → both map to Cultural)
DELETE FROM users.user_cultural_interests
WHERE Id NOT IN (
  SELECT MIN(Id)
  FROM users.user_cultural_interests
  GROUP BY UserId, interest_code
);
```

### 6.3 UI/UX Best Practices

**Guideline**: "Unlimited" Should Mean "No UI Limit Display"

**Bad Pattern**:
```typescript
// ❌ WRONG: Using 999 as "effectively unlimited"
max: 999

// UI shows: "choose 0-999 interests"
// User confused: Why 999? Is there a limit?
```

**Good Pattern**:
```typescript
// ✅ CORRECT: Omit max property entirely
culturalInterests: {
  min: 0,
  // No max property - unlimited allowed
}

// UI shows: "Select event categories that interest you"
// No counter, no limit display
```

**Implementation**:
```typescript
// Conditional rendering based on max property existence
{PROFILE_CONSTRAINTS.culturalInterests.max && (
  <p>Maximum {PROFILE_CONSTRAINTS.culturalInterests.max} allowed</p>
)}

// Or use undefined/null to indicate unlimited
culturalInterests: {
  min: 0,
  max: undefined,  // Unlimited
}
```

### 6.4 Testing Checklist for Future Releases

**Pre-Deployment Testing**:
```
□ Local build: 0 errors, 0 warnings
□ Unit tests: 100% passing
□ Integration tests: API endpoints tested
□ Frontend build: No TypeScript errors
□ Frontend E2E: Cypress/Playwright tests passing
□ Database migrations: Tested on staging clone
□ Deployment script: Dry-run successful
```

**Post-Deployment Testing**:
```
□ Health check: API returns 200 OK
□ Smoke tests: Critical paths functional
□ Container logs: No errors in last 100 lines
□ Database: Migrations applied successfully
□ Frontend: UI loads without console errors
□ API version: Correct commit SHA deployed
□ Rollback plan: Tested and documented
```

---

## SECTION 7: SUMMARY AND NEXT ACTIONS

### 7.1 Issue Summary Table

| Issue | Root Cause | Impact | Fix Required | Estimated Time |
|-------|-----------|--------|--------------|----------------|
| #1: "999" limit shows | UI hardcoded with constraint constant | Confusing UX | Remove limit text from UI | 30 min |
| #2: 7 interests missing | Legacy data + new EventCategory mismatch | Data visibility gap | Clear database + mapping | 1 hour |
| #3: Validation in UI | Unnecessary max checks in component | Restrictive UX | Remove validation logic | 30 min |
| #4: "Invalid code: Business" | Azure staging runs old code | Feature broken | Deploy to Azure | 15 min |

**Total Estimated Time**: 2 hours 15 minutes

### 7.2 Critical Path to Resolution

**Immediate Actions** (resolve in next 2 hours):
1. ✅ Verify Azure deployment status (15 min)
2. ⚠️ Deploy backend if needed (15 min)
3. ⚠️ Execute database cleanup (30 min)
4. ✅ Remove UI limit display (30 min)
5. ✅ Deploy frontend changes (15 min)
6. ✅ End-to-end testing (30 min)

**Follow-Up Actions** (within 24 hours):
7. Monitor Azure logs for errors
8. Communicate to users about re-selecting interests
9. Document lessons learned
10. Update deployment checklist

**Long-Term Improvements** (next sprint):
11. Add automated deployment verification
12. Create data migration scripts for future enum changes
13. Implement E2E tests for interest selection
14. Add monitoring alerts for API errors

### 7.3 Success Criteria

**Definition of Done**:
- ✅ UI shows NO limit text (not "999")
- ✅ UI shows NO counter (not "X of 999 selected")
- ✅ Backend accepts EventCategory codes without error
- ✅ Users can select all 8 EventCategory interests
- ✅ Database stores interests correctly
- ✅ Azure staging runs latest code
- ✅ Zero errors in container logs
- ✅ E2E test passes

### 7.4 Risk Assessment

**Low Risk**:
- UI changes (easily reversible)
- Database cleanup (backed up, can restore)

**Medium Risk**:
- Backend deployment (rollback available)
- Data migration (mapping logic needs validation)

**High Risk**:
- None (all changes are non-breaking)

**Mitigation**:
- Database backup before cleanup
- Rollback plan tested
- Gradual rollout (staging → production)
- User communication prepared

---

## APPENDIX A: Useful Commands

### Database Queries
```sql
-- Count interests per user
SELECT u.email, COUNT(uci.interest_code) as interest_count
FROM identity.users u
LEFT JOIN users.user_cultural_interests uci ON u.id = uci.UserId
GROUP BY u.email
ORDER BY interest_count DESC;

-- Find users with legacy codes
SELECT DISTINCT uci.interest_code
FROM users.user_cultural_interests uci
WHERE uci.interest_code NOT IN ('Religious','Cultural','Community','Educational','Social','Business','Charity','Entertainment');

-- Verify unique constraint
SELECT UserId, interest_code, COUNT(*)
FROM users.user_cultural_interests
GROUP BY UserId, interest_code
HAVING COUNT(*) > 1;
```

### Azure CLI Commands
```bash
# Get connection string from Key Vault
az keyvault secret show \
  --vault-name lankaconnect-staging-kv \
  --name DATABASE-CONNECTION-STRING \
  --query value -o tsv

# Restart container app
az containerapp restart \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging

# Check app revision status
az containerapp revision list \
  --name lankaconnect-api-staging \
  --resource-group lankaconnect-staging \
  --query '[].{Name:name,CreatedTime:properties.createdTime,Active:properties.active}'
```

### Git Commands
```bash
# Check commit history for Phase 6A.47
git log --oneline --grep="6a47" -n 10

# Show files changed in specific commit
git show d0a5df9e --name-only

# Compare local vs remote
git diff develop origin/develop
```

---

## APPENDIX B: Contact and Escalation

**Issue Owner**: System Architecture Designer
**Priority**: P2 - Medium (UX issue, no data loss)
**Affected Users**: All users editing Event Interests
**Estimated Impact**: 100% of users (UI confusion)

**Escalation Path**:
1. Developer → Team Lead (if rollback needed)
2. Team Lead → DevOps (if Azure issues persist)
3. DevOps → Database Admin (if data migration fails)

**Communication Template** (for users):
```
Subject: Event Interests Feature Update

Hi [User],

We've updated our Event Interests feature to provide a better experience!

What's changed:
• Simplified interest selection (no more confusing limits)
• Updated categories to better match our events
• Improved performance

What you need to do:
• Please re-select your event interests in your profile
• Your previous selections have been reset to ensure data accuracy

Thank you for your patience!

— LankaConnect Team
```

---

**End of Root Cause Analysis**

*Generated: 2025-12-28*
*Next Review: After deployment completion*
