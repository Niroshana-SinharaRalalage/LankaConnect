# Email Groups Many-to-Many Architecture - Visual Diagrams

## C4 Model: Container Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          EVENT ORGANIZER USER                                â”‚
â”‚                    (Updates event with email groups)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ HTTPS Request
                                 â”‚ PUT /api/events/{id}
                                 â”‚ { emailGroupIds: [...] }
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            API LAYER (ASP.NET Core)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ EventsController                                            â”‚            â”‚
â”‚  â”‚ - [Authorize(EventOrganizer)]                              â”‚            â”‚
â”‚  â”‚ - Validates JWT token                                       â”‚            â”‚
â”‚  â”‚ - Maps request to UpdateEventCommand                        â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ MediatR Command
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APPLICATION LAYER (CQRS + MediatR)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ UpdateEventCommandHandler                                             â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Step 1: Load Event                                                   â”‚  â”‚
â”‚  â”‚    â”œâ”€> _eventRepository.GetByIdAsync()                               â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Step 2: Load & Validate EmailGroups (Batch Query)                   â”‚  â”‚
â”‚  â”‚    â”œâ”€> _emailGroupRepository.GetByIdsAsync(ids)                      â”‚  â”‚
â”‚  â”‚    â”œâ”€> Validate: existence, ownership, isActive                      â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Step 3: Domain Business Logic                                       â”‚  â”‚
â”‚  â”‚    â”œâ”€> @event.SetEmailGroups(ids)                                   â”‚  â”‚
â”‚  â”‚    â”‚    â””â”€> Updates _emailGroupIds âœ…                                â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Step 4: Infrastructure Sync (ChangeTracker API) â­                 â”‚  â”‚
â”‚  â”‚    â”œâ”€> dbContext.Entry(@event).Collection("_emailGroupEntities")    â”‚  â”‚
â”‚  â”‚    â”œâ”€> await collection.LoadAsync()                                  â”‚  â”‚
â”‚  â”‚    â”œâ”€> currentEmailGroups.Clear()                                    â”‚  â”‚
â”‚  â”‚    â”œâ”€> currentEmailGroups.Add(emailGroup) foreach                   â”‚  â”‚
â”‚  â”‚    â”‚    â””â”€> Updates _emailGroupEntities âœ…                          â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Step 5: Persist Changes                                             â”‚  â”‚
â”‚  â”‚    â””â”€> _unitOfWork.CommitAsync()                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Domain Objects
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DOMAIN LAYER (Business Logic)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Event Aggregate (DDD)                                                 â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Collections:                                                         â”‚  â”‚
â”‚  â”‚    â”œâ”€> _emailGroupIds: List<Guid>                                   â”‚  â”‚
â”‚  â”‚    â”‚    â””â”€> Used for: Business logic, domain methods               â”‚  â”‚
â”‚  â”‚    â”‚    â””â”€> Exposed as: IReadOnlyList<Guid> EmailGroupIds          â”‚  â”‚
â”‚  â”‚    â”‚                                                                  â”‚  â”‚
â”‚  â”‚    â””â”€> _emailGroupEntities: List<EmailGroup>                        â”‚  â”‚
â”‚  â”‚         â””â”€> Used for: EF Core change tracking (shadow navigation)   â”‚  â”‚
â”‚  â”‚         â””â”€> NOT exposed publicly (infrastructure concern)            â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Domain Methods:                                                      â”‚  â”‚
â”‚  â”‚    â”œâ”€> SetEmailGroups(IEnumerable<Guid> ids)                        â”‚  â”‚
â”‚  â”‚    â”‚    â”œâ”€> Validates: not null, distinct                           â”‚  â”‚
â”‚  â”‚    â”‚    â”œâ”€> _emailGroupIds.Clear()                                  â”‚  â”‚
â”‚  â”‚    â”‚    â”œâ”€> _emailGroupIds.AddRange(ids.Distinct())                 â”‚  â”‚
â”‚  â”‚    â”‚    â”œâ”€> MarkAsUpdated()                                          â”‚  â”‚
â”‚  â”‚    â”‚    â””â”€> Returns Result                                           â”‚  â”‚
â”‚  â”‚    â”‚                                                                  â”‚  â”‚
â”‚  â”‚    â”œâ”€> AssignEmailGroups(IEnumerable<Guid> ids)                     â”‚  â”‚
â”‚  â”‚    â”œâ”€> RemoveEmailGroups(IEnumerable<Guid> ids)                     â”‚  â”‚
â”‚  â”‚    â””â”€> ClearEmailGroups()                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ EF Core Entities
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  INFRASTRUCTURE LAYER (Data Access)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ EventConfiguration (EF Core Fluent API)                               â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Many-to-Many Configuration:                                          â”‚  â”‚
â”‚  â”‚    builder                                                             â”‚  â”‚
â”‚  â”‚      .HasMany<EmailGroup>("_emailGroupEntities")   â† Shadow nav      â”‚  â”‚
â”‚  â”‚      .WithMany()                                                       â”‚  â”‚
â”‚  â”‚      .UsingEntity<Dictionary<string, object>>(                        â”‚  â”‚
â”‚  â”‚          "event_email_groups",                     â† Junction table   â”‚  â”‚
â”‚  â”‚          j => j.HasOne<EmailGroup>()                                  â”‚  â”‚
â”‚  â”‚                .WithMany()                                             â”‚  â”‚
â”‚  â”‚                .HasForeignKey("email_group_id")                       â”‚  â”‚
â”‚  â”‚                .OnDelete(DeleteBehavior.Cascade),                     â”‚  â”‚
â”‚  â”‚          j => j.HasOne<Event>()                                       â”‚  â”‚
â”‚  â”‚                .WithMany()                                             â”‚  â”‚
â”‚  â”‚                .HasForeignKey("event_id")                             â”‚  â”‚
â”‚  â”‚                .OnDelete(DeleteBehavior.Cascade)                      â”‚  â”‚
â”‚  â”‚      )                                                                 â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Change Tracking:                                                      â”‚  â”‚
â”‚  â”‚    â”œâ”€> ChangeTracker monitors _emailGroupEntities                    â”‚  â”‚
â”‚  â”‚    â”œâ”€> Detects: Added, Removed, Modified                             â”‚  â”‚
â”‚  â”‚    â””â”€> Generates SQL for junction table                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ SQL Commands
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATABASE (PostgreSQL)                                   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ events                 â”‚         â”‚ event_email_groups          â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚ (Junction Table)            â”‚        â”‚
â”‚  â”‚ id (PK)               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤ event_id (FK)              â”‚        â”‚
â”‚  â”‚ title                 â”‚         â”‚ email_group_id (FK)         â”‚â”€â”€â”€â”    â”‚
â”‚  â”‚ organizer_id          â”‚         â”‚ assigned_at                 â”‚   â”‚    â”‚
â”‚  â”‚ ...                   â”‚         â”‚ PRIMARY KEY (event_id,      â”‚   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚              email_group_id)â”‚   â”‚    â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚                                                                       â”‚    â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚                                     â”‚ email_groups                â”‚â—„â”€â”€â”˜    â”‚
â”‚                                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚                                     â”‚ id (PK)                    â”‚        â”‚
â”‚                                     â”‚ owner_id (FK)              â”‚        â”‚
â”‚                                     â”‚ name                        â”‚        â”‚
â”‚                                     â”‚ is_active                   â”‚        â”‚
â”‚                                     â”‚ ...                         â”‚        â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Sequence Diagram: Update Event with Email Groups

```
Event Organizer  API Controller  UpdateEventHandler  Event Aggregate  ChangeTracker  Database
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚  PUT /events/X â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚  UpdateEvent     â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚  Command         â”‚                  â”‚               â”‚           â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  Load Event      â”‚               â”‚           â”‚
     â”‚                â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
     â”‚                â”‚                  â”‚  Event Entity    â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  Load EmailGroups (batch)       â”‚           â”‚
     â”‚                â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
     â”‚                â”‚                  â”‚  EmailGroup[]    â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  Validate:       â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  - Existence âœ…  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  - Ownership âœ…  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  - IsActive âœ…   â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  SetEmailGroups(ids)            â”‚           â”‚
     â”‚                â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚  Business     â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚  Rules:       â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚  - Distinct âœ…â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚  - No empty âœ…â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚  Update       â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚  _emailGroupIds           â”‚
     â”‚                â”‚                  â”‚                  â”‚  âœ…           â”‚           â”‚
     â”‚                â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚           â”‚
     â”‚                â”‚                  â”‚  Result.Success  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  â­ CRITICAL FIX â­              â”‚           â”‚
     â”‚                â”‚                  â”‚  Entry(@event)   â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  .Collection("_emailGroupEntities")          â”‚
     â”‚                â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  LoadAsync()     â”‚               â”‚           â”‚
     â”‚                â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚
     â”‚                â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
     â”‚                â”‚                  â”‚  Tracked Collection              â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  Clear() + Add() â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  (sync entities) â”‚               â”‚           â”‚
     â”‚                â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚  Update       â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚  _emailGroupEntities      â”‚
     â”‚                â”‚                  â”‚                  â”‚  âœ…           â”‚           â”‚
     â”‚                â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚  SaveChangesAsync()             â”‚           â”‚
     â”‚                â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  Detect   â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  Changes  â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  in       â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  _emailGroupEntities
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  Generate â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  SQL:     â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  DELETE + â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  INSERT   â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  into     â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  event_   â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  email_   â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚  groups   â”‚
     â”‚                â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
     â”‚                â”‚                  â”‚  Success         â”‚               â”‚           â”‚
     â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚               â”‚           â”‚
     â”‚                â”‚  Result.Success  â”‚                  â”‚               â”‚           â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚               â”‚           â”‚
     â”‚  200 OK        â”‚                  â”‚                  â”‚               â”‚           â”‚
     â”‚                â”‚                  â”‚                  â”‚               â”‚           â”‚
```

---

## Data Flow Diagram: The Two Collections Problem

### BEFORE FIX (Broken)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Domain Layer                                   â”‚
â”‚                                                                   â”‚
â”‚  Event {                                                          â”‚
â”‚    _emailGroupIds: [guid1, guid2] â—„â”€â”€ Updated by SetEmailGroups()â”‚
â”‚    _emailGroupEntities: []         â—„â”€â”€ NEVER UPDATED âŒ          â”‚
â”‚  }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ SaveChanges()
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 EF Core Change Tracker                            â”‚
â”‚                                                                   â”‚
â”‚  Tracked Changes:                                                 â”‚
â”‚    _emailGroupIds: Modified (but not mapped to database)         â”‚
â”‚    _emailGroupEntities: Unchanged âŒ                             â”‚
â”‚                                                                   â”‚
â”‚  Result: No SQL generated for junction table                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ No INSERT/DELETE
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Database                                     â”‚
â”‚                                                                   â”‚
â”‚  event_email_groups: EMPTY âŒ                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AFTER FIX (Working)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Domain Layer                                   â”‚
â”‚                                                                   â”‚
â”‚  Event {                                                          â”‚
â”‚    _emailGroupIds: [guid1, guid2] â—„â”€â”€ Updated by SetEmailGroups()â”‚
â”‚    _emailGroupEntities: []         â—„â”€â”€ Populated by             â”‚
â”‚  }                                     ChangeTracker API âœ…       â”‚
â”‚                                                                   â”‚
â”‚  Handler syncs collections using:                                 â”‚
â”‚    dbContext.Entry(@event).Collection("_emailGroupEntities")     â”‚
â”‚      .CurrentValue.Clear()                                        â”‚
â”‚      .Add(emailGroup1)                                            â”‚
â”‚      .Add(emailGroup2)                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ SaveChanges()
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 EF Core Change Tracker                            â”‚
â”‚                                                                   â”‚
â”‚  Tracked Changes:                                                 â”‚
â”‚    _emailGroupIds: Modified (domain state)                       â”‚
â”‚    _emailGroupEntities: Added [emailGroup1, emailGroup2] âœ…      â”‚
â”‚                                                                   â”‚
â”‚  Result: Generates SQL for junction table âœ…                     â”‚
â”‚    DELETE FROM event_email_groups WHERE event_id = X             â”‚
â”‚    INSERT INTO event_email_groups VALUES (X, guid1), (X, guid2)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ INSERT/DELETE
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Database                                     â”‚
â”‚                                                                   â”‚
â”‚  event_email_groups:                                              â”‚
â”‚    (event_id: X, email_group_id: guid1) âœ…                       â”‚
â”‚    (event_id: X, email_group_id: guid2) âœ…                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Diagram: Architectural Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                         â”‚   API Controllers    â”‚                            â”‚
â”‚                         â”‚  (Presentation)      â”‚                            â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â”‚ Command/Query                           â”‚
â”‚                                    â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                         â”‚  Command Handlers    â”‚                            â”‚
â”‚                         â”‚  (Application)       â”‚                            â”‚
â”‚                         â”‚                      â”‚                            â”‚
â”‚                         â”‚  - Orchestration     â”‚                            â”‚
â”‚                         â”‚  - Validation        â”‚                            â”‚
â”‚                         â”‚  - Entity Loading    â”‚                            â”‚
â”‚                         â”‚  - Collection Sync â­â”‚                            â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                    â”‚                                         â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                         â”‚  Repositories        â”‚                            â”‚
â”‚                         â”‚  (Interfaces)        â”‚                            â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                         â”‚  Event Aggregate     â”‚                            â”‚
â”‚                         â”‚  (Domain)            â”‚                            â”‚
â”‚                         â”‚                      â”‚                            â”‚
â”‚                         â”‚  Business Logic:     â”‚                            â”‚
â”‚                         â”‚  - _emailGroupIds âœ… â”‚                            â”‚
â”‚                         â”‚  - SetEmailGroups()  â”‚                            â”‚
â”‚                         â”‚  - Business Rules    â”‚                            â”‚
â”‚                         â”‚                      â”‚                            â”‚
â”‚                         â”‚  Infrastructure:     â”‚                            â”‚
â”‚                         â”‚  - _emailGroupEntitiesâ”‚                            â”‚
â”‚                         â”‚    (shadow nav)      â”‚                            â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                         â”‚ EventConfiguration   â”‚                            â”‚
â”‚                         â”‚ (Infrastructure)     â”‚                            â”‚
â”‚                         â”‚                      â”‚                            â”‚
â”‚                         â”‚ - EF Core Config     â”‚                            â”‚
â”‚                         â”‚ - Many-to-Many       â”‚                            â”‚
â”‚                         â”‚ - Junction Table     â”‚                            â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                    â”‚                                         â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                         â”‚  EF Core DbContext   â”‚                            â”‚
â”‚                         â”‚  - ChangeTracker     â”‚                            â”‚
â”‚                         â”‚  - SaveChanges       â”‚                            â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                    â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                         â”‚   PostgreSQL         â”‚                            â”‚
â”‚                         â”‚   - events           â”‚                            â”‚
â”‚                         â”‚   - event_email_groupsâ”‚                            â”‚
â”‚                         â”‚   - email_groups     â”‚                            â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Technology Evaluation Matrix

| Aspect | Evaluation | Score |
|--------|------------|-------|
| **Architectural Alignment** | Follows ADR-008 pattern | âœ…âœ…âœ…âœ…âœ… 5/5 |
| **Clean Architecture** | Domain pure, infrastructure separate | âœ…âœ…âœ…âœ…âœ… 5/5 |
| **DDD Principles** | Aggregate encapsulation maintained | âœ…âœ…âœ…âœ…âœ… 5/5 |
| **EF Core Best Practices** | Uses ChangeTracker API | âœ…âœ…âœ…âœ…âœ… 5/5 |
| **Maintainability** | Consistent with existing code | âœ…âœ…âœ…âœ…âœ… 5/5 |
| **Testability** | Can mock ChangeTracker | âœ…âœ…âœ…âœ…âšª 4/5 |
| **Performance** | Batch queries, explicit loading | âœ…âœ…âœ…âœ…âšª 4/5 |
| **Complexity** | Moderate (application layer logic) | âœ…âœ…âœ…âšªâšª 3/5 |
| **Developer Understanding** | Requires EF Core knowledge | âœ…âœ…âœ…âšªâšª 3/5 |

**Overall Score**: 4.3/5 âœ… Recommended

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Breaking existing functionality | Low | High | Follow established pattern (ADR-008) |
| Performance degradation | Low | Medium | Batch queries already implemented |
| Developer confusion | Medium | Low | Comprehensive documentation + ADR |
| EF Core tracking issues | Low | Medium | Explicit loading + SaveChanges |
| Database integrity violation | Very Low | High | Foreign key constraints + cascade delete |

**Risk Level**: ğŸŸ¢ LOW (Established pattern, non-breaking change)

---

## Quality Attributes Assessment

### Performance
- **Current**: Junction table empty (0 queries)
- **After Fix**: 2-3 queries (batch load + sync + save)
- **Impact**: Minimal (milliseconds)

### Scalability
- **Junction Table Size**: O(events Ã— avg_groups_per_event)
- **Query Performance**: Indexed on both FKs âœ…
- **Batch Operations**: Single query for N groups âœ…

### Maintainability
- **Pattern Consistency**: Matches ADR-008 âœ…
- **Code Duplication**: Minimal (handler logic)
- **Documentation**: Comprehensive ADR + guide âœ…

### Security
- **Authorization**: Organizer-only access âœ…
- **Validation**: Ownership + active status âœ…
- **SQL Injection**: Protected by EF Core âœ…

### Reliability
- **Foreign Key Constraints**: Database-level integrity âœ…
- **Cascade Delete**: Safe with soft delete pattern âœ…
- **Transaction Support**: Unit of Work pattern âœ…

---

## Decision Record Summary

**Status**: âœ… RECOMMENDED

**Chosen Pattern**: ChangeTracker API Synchronization (ADR-008)

**Rationale**:
1. Established architectural pattern (already used for User.PreferredMetroAreas)
2. Maintains Clean Architecture boundaries
3. Respects DDD principles
4. Uses EF Core best practices
5. Explicit and maintainable

**Trade-offs Accepted**:
- Application layer complexity (sync logic in handler)
- Requires EF Core knowledge (ChangeTracker API)
- Moderate implementation effort

**Alternatives Rejected**:
- Domain accepts entities (breaks Clean Architecture)
- DbContext override (hidden magic, hard to debug)
- Reflection in handler (fragile, breaks encapsulation)
- Remove _emailGroupIds (breaks DDD layering)
- Explicit join entity (unnecessary complexity)

---

**Related Documents**:
- ADR-009: Email Groups Many-to-Many Architecture
- ADR-008: User Preferred Metro Areas
- EMAIL_GROUPS_FIX_IMPLEMENTATION_GUIDE.md

**Date**: 2025-12-16
**Author**: System Architect
**Reviewers**: Development Team
