# Event Cancellation Timeout Fix - C4 Architecture Diagrams

**Date**: 2026-01-07
**Component**: Event Cancellation Email Notifications
**Phases**: Phase 1 (Hotfix) and Phase 2 (Background Jobs)

---

## Table of Contents

1. [System Context Diagram (C4 Level 1)](#system-context-diagram)
2. [Container Diagram (C4 Level 2)](#container-diagram)
3. [Component Diagram - Phase 0 (Current State)](#component-diagram---phase-0-current-state)
4. [Component Diagram - Phase 1 (Hotfix)](#component-diagram---phase-1-hotfix)
5. [Component Diagram - Phase 2 (Background Jobs)](#component-diagram---phase-2-background-jobs)
6. [Sequence Diagram - Phase 0](#sequence-diagram---phase-0-current-state)
7. [Sequence Diagram - Phase 1](#sequence-diagram---phase-1-hotfix)
8. [Sequence Diagram - Phase 2](#sequence-diagram---phase-2-background-jobs)
9. [Deployment Diagram](#deployment-diagram)

---

## System Context Diagram

**C4 Level 1: System Context**

Shows how the LankaConnect system interacts with users and external systems for event cancellation.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚                         LankaConnect System                            â”‚
â”‚                                                                        â”‚
â”‚  Handles event lifecycle management including creation, publishing,   â”‚
â”‚  registration, and cancellation with email notifications              â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                          â”‚
             â”‚ Manages events,                          â”‚ Sends cancellation
             â”‚ sends cancellation                       â”‚ emails via API
             â”‚ request via HTTPS                        â”‚
             â”‚                                          â”‚
             â–¼                                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚                       â”‚                      â”‚
    â”‚  Event Organizerâ”‚                       â”‚  Azure Communication â”‚
    â”‚                 â”‚                       â”‚      Services        â”‚
    â”‚ Cancels events  â”‚                       â”‚                      â”‚
    â”‚ Notifies users  â”‚                       â”‚  Sends SMTP emails   â”‚
    â”‚                 â”‚                       â”‚  to recipients       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                          â”‚
             â”‚ Receives email                           â”‚
             â”‚ notification                             â”‚ Delivers email
             â–¼                                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚                       â”‚                      â”‚
    â”‚  Event Attendeesâ”‚                       â”‚  Email Recipients    â”‚
    â”‚                 â”‚                       â”‚                      â”‚
    â”‚ Confirmed       â”‚                       â”‚ - Confirmed users    â”‚
    â”‚ registrations   â”‚                       â”‚ - Email group membersâ”‚
    â”‚                 â”‚                       â”‚ - Newsletter subs    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
  Person/Actor    â”‚ Software System â”‚ External System
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Represented by  â”‚ LankaConnect    â”‚ Azure, Email
  boxes with      â”‚ (this system)   â”‚ service providers
  descriptive textâ”‚                 â”‚
```

---

## Container Diagram

**C4 Level 2: Containers**

Shows the high-level architecture of containers (applications, data stores) within LankaConnect.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LankaConnect System                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Next.js Frontend   â”‚           â”‚   ASP.NET Core API   â”‚         â”‚
â”‚  â”‚   (React/TypeScript) â”‚           â”‚   (C# .NET 8)        â”‚         â”‚
â”‚  â”‚                      â”‚  HTTPS    â”‚                      â”‚         â”‚
â”‚  â”‚ - Event management UIâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ - REST API           â”‚         â”‚
â”‚  â”‚ - Cancel event modal â”‚           â”‚ - MediatR pipeline   â”‚         â”‚
â”‚  â”‚ - State management   â”‚           â”‚ - Domain events      â”‚         â”‚
â”‚  â”‚                      â”‚           â”‚ - Command handlers   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                 â”‚                     â”‚
â”‚                                                 â”‚ Entity Framework    â”‚
â”‚                                                 â”‚ Core                â”‚
â”‚                                                 â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Hangfire Dashboard  â”‚           â”‚  PostgreSQL Database â”‚         â”‚
â”‚  â”‚  (Background Jobs)   â”‚           â”‚                      â”‚         â”‚
â”‚  â”‚                      â”‚  Reads    â”‚ - Events table       â”‚         â”‚
â”‚  â”‚ - Job monitoring     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ - Registrations      â”‚         â”‚
â”‚  â”‚ - Retry failed jobs  â”‚           â”‚ - Users              â”‚         â”‚
â”‚  â”‚ - Job history        â”‚           â”‚ - Hangfire schema    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚            â–²                                    â–²                     â”‚
â”‚            â”‚                                    â”‚                     â”‚
â”‚            â”‚ Processes jobs                     â”‚ Stores jobs         â”‚
â”‚            â”‚                                    â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚                     â”‚
â”‚  â”‚  Hangfire Worker     â”‚                      â”‚                     â”‚
â”‚  â”‚  (Background Service)â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚  â”‚                      â”‚  Persists job state                        â”‚
â”‚  â”‚ - Email queue        â”‚                                            â”‚
â”‚  â”‚ - Job execution      â”‚                                            â”‚
â”‚  â”‚ - Retry mechanism    â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚             â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ Sends emails via API
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Azure Communication  â”‚
    â”‚      Services        â”‚
    â”‚                      â”‚
    â”‚ - SMTP relay         â”‚
    â”‚ - Email delivery     â”‚
    â”‚ - Bounce handling    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Technology Stack:
  Frontend: Next.js 14, React 18, TypeScript, TailwindCSS
  API: ASP.NET Core 8, C#, MediatR, Entity Framework Core
  Database: PostgreSQL 15 with PostGIS
  Background Jobs: Hangfire (PostgreSQL storage)
  Email: Azure Communication Services
  Hosting: Azure Container Apps (API), Azure Static Web Apps (Frontend)
```

---

## Component Diagram - Phase 0 (Current State)

**C4 Level 3: Components - Before Optimization**

Shows internal components within the API container and their interactions.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ASP.NET Core API Container                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Presentation Layer                            â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚             EventsController                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  [HttpPost("{id:guid}/cancel")]                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  public async Task<IActionResult> CancelEvent(             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚      Guid id, CancelEventRequest request)                  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  {                                                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚      var command = new CancelEventCommand(id, request.Reason); â”‚
â”‚  â”‚  â”‚      var result = await Mediator.Send(command); // â”€â”€â”€â”    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚      return HandleResult(result);                      â”‚    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  }                                                     â”‚    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                     Application Layer                              â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚       CancelEventCommandHandler                             â”‚  â”‚â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚â”‚
â”‚  â”‚  â”‚  1. GetByIdAsync(eventId, trackChanges: true)              â”‚  â”‚â”‚
â”‚  â”‚  â”‚  2. event.Cancel(reason) // Raises EventCancelledEvent     â”‚  â”‚â”‚
â”‚  â”‚  â”‚  3. _unitOfWork.CommitAsync() // â”€â”€â”€â” BLOCKS 30+ SECONDS   â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜  â”‚â”‚
â”‚  â”‚                                         â”‚                     â”‚    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚       EventCancelledEventHandler (Domain Event Handler)      â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                               â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Handle(EventCancelledEvent notification)                    â”‚ â”‚â”‚
â”‚  â”‚  â”‚  {                                                            â”‚ â”‚â”‚
â”‚  â”‚  â”‚    1. Load event data                             (100ms)    â”‚ â”‚â”‚
â”‚  â”‚  â”‚    2. Load registrations                          (200ms)    â”‚ â”‚â”‚
â”‚  â”‚  â”‚    3. For each registration:                                 â”‚ â”‚â”‚
â”‚  â”‚  â”‚         âŒ Load user ONE-BY-ONE (N+1)           (5-10 sec)   â”‚ â”‚â”‚
â”‚  â”‚  â”‚    4. Resolve email groups + newsletter         (2-3 sec)    â”‚ â”‚â”‚
â”‚  â”‚  â”‚    5. For each recipient:                                    â”‚ â”‚â”‚
â”‚  â”‚  â”‚         Send email sequentially                 (15-20 sec)  â”‚ â”‚â”‚
â”‚  â”‚  â”‚  }                                                            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Total: 30-45 seconds âŒ TIMEOUT                             â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Infrastructure Layer                          â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   UnitOfWork    â”‚  â”‚  EventRepositoryâ”‚  â”‚  UserRepository â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  CommitAsync()  â”‚  â”‚  GetByIdAsync() â”‚  â”‚  GetByIdAsync() â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€SaveChanges()â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  (N+1 queries!) â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€DispatchEvents                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  EmailService   â”‚  â”‚  EventNotificationRecipientService   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  SendTemplated  â”‚  â”‚  ResolveRecipientsAsync()            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  EmailAsync()   â”‚  â”‚  - Email groups                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  (300-500ms     â”‚  â”‚  - Newsletter subscribers            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   per email)    â”‚  â”‚  - Metro/State matching              â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸš¨ Problems:
  1. N+1 Query Pattern: 50 users = 50 separate DB queries (5-10 seconds)
  2. Synchronous Email Sending: Blocks until all emails sent (15-20 seconds)
  3. No Timeout Protection: Handler runs indefinitely
  4. Transaction Includes Non-Critical Operations: Email sending blocks DB commit
  5. Total Time: 30-45 seconds (exceeds 30s frontend timeout)
```

---

## Component Diagram - Phase 1 (Hotfix)

**C4 Level 3: Components - After Query Optimization**

Shows optimized query pattern that reduces N+1 queries to single bulk query.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ASP.NET Core API Container                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Presentation Layer                            â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚             EventsController                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  [HttpPost("{id:guid}/cancel")]                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  public async Task<IActionResult> CancelEvent(...)         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  {                                                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚      var result = await Mediator.Send(command); // â”€â”€â”€â”    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚      return HandleResult(result);                      â”‚    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  }                                                     â”‚    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                     Application Layer                              â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚       CancelEventCommandHandler                             â”‚  â”‚â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚â”‚
â”‚  â”‚  â”‚  1. GetByIdAsync(eventId, trackChanges: true)              â”‚  â”‚â”‚
â”‚  â”‚  â”‚  2. event.Cancel(reason) // Raises EventCancelledEvent     â”‚  â”‚â”‚
â”‚  â”‚  â”‚  3. _unitOfWork.CommitAsync() // â”€â”€â”€â” FASTER (15-25s)      â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜  â”‚â”‚
â”‚  â”‚                                         â”‚                     â”‚    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚       EventCancelledEventHandler (OPTIMIZED)                 â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                               â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Handle(EventCancelledEvent notification)                    â”‚ â”‚â”‚
â”‚  â”‚  â”‚  {                                                            â”‚ â”‚â”‚
â”‚  â”‚  â”‚    Stopwatch sw = Stopwatch.StartNew(); // â† Performance log â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                               â”‚ â”‚â”‚
â”‚  â”‚  â”‚    1. Load event data                             (100ms)    â”‚ â”‚â”‚
â”‚  â”‚  â”‚    2. Load registrations                          (200ms)    â”‚ â”‚â”‚
â”‚  â”‚  â”‚    3. âœ… BULK load user emails:                              â”‚ â”‚â”‚
â”‚  â”‚  â”‚         var userIds = registrations                          â”‚ â”‚â”‚
â”‚  â”‚  â”‚            .Select(r => r.UserId.Value).ToList();            â”‚ â”‚â”‚
â”‚  â”‚  â”‚         var emails = await _userRepository                   â”‚ â”‚â”‚
â”‚  â”‚  â”‚            .GetEmailsByUserIdsAsync(userIds);    (100ms!) âœ… â”‚ â”‚â”‚
â”‚  â”‚  â”‚    4. Resolve email groups + newsletter         (2-3 sec)    â”‚ â”‚â”‚
â”‚  â”‚  â”‚    5. For each recipient:                                    â”‚ â”‚â”‚
â”‚  â”‚  â”‚         Send email sequentially                 (15-20 sec)  â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                               â”‚ â”‚â”‚
â”‚  â”‚  â”‚    sw.Stop();                                                â”‚ â”‚â”‚
â”‚  â”‚  â”‚    _logger.LogInformation("Duration: {0}ms", sw.Elapsed);    â”‚ â”‚â”‚
â”‚  â”‚  â”‚  }                                                            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Total: 15-25 seconds âœ… 95% SUCCESS RATE                    â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Infrastructure Layer                          â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚   UnitOfWork    â”‚  â”‚  UserRepository (NEW METHOD)        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                                     â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  CommitAsync()  â”‚  â”‚  âœ… GetEmailsByUserIdsAsync(        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€SaveChanges()â”‚  â”‚       IEnumerable<Guid> userIds)    â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€DispatchEvents  â”‚  {                                 â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    return await _dbSet              â”‚    â”‚  â”‚
â”‚  â”‚                       â”‚      .AsNoTracking()                â”‚    â”‚  â”‚
â”‚  â”‚                       â”‚      .Where(u => userIds            â”‚    â”‚  â”‚
â”‚  â”‚                       â”‚              .Contains(u.Id))       â”‚    â”‚  â”‚
â”‚  â”‚                       â”‚      .ToDictionaryAsync(            â”‚    â”‚  â”‚
â”‚  â”‚                       â”‚        u => u.Id,                   â”‚    â”‚  â”‚
â”‚  â”‚                       â”‚        u => u.Email.Value);         â”‚    â”‚  â”‚
â”‚  â”‚                       â”‚  }                                  â”‚    â”‚  â”‚
â”‚  â”‚                       â”‚  // Single query: 50 users = 1 DB query! â”‚ â”‚
â”‚  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  EmailService   â”‚  â”‚  EventNotificationRecipientService   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚  (Unchanged)                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  SendTemplated  â”‚  â”‚                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  EmailAsync()   â”‚  â”‚  ResolveRecipientsAsync()            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  (Still        â”‚  â”‚  - Email groups                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   sequential)   â”‚  â”‚  - Newsletter subscribers            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Improvements:
  1. Bulk Email Query: 50 users = 1 DB query (10-20x faster!)
  2. Performance Logging: Track operation duration
  3. Frontend Timeout: 90 seconds (accommodates slower operations)
  4. State Management: Frontend refetches on error (no stale state)
  5. Total Time: 15-25 seconds (10-20s improvement, 95% success rate)

âš ï¸ Remaining Issues:
  - Still blocks user for 15-25 seconds
  - Doesn't scale to 500+ recipients
  - Email sending still synchronous in transaction
```

---

## Component Diagram - Phase 2 (Background Jobs)

**C4 Level 3: Components - After Background Job Implementation**

Shows asynchronous email processing using Hangfire background jobs.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ASP.NET Core API Container                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Presentation Layer                            â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚             EventsController                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  [HttpPost("{id:guid}/cancel")]                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  public async Task<IActionResult> CancelEvent(...)         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  {                                                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚      var result = await Mediator.Send(command); // â”€â”€â”€â”    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚      return HandleResult(result);  // <1 second! âœ…    â”‚    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  }                                                     â”‚    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                     Application Layer                              â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚       CancelEventCommandHandler                             â”‚  â”‚â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚â”‚
â”‚  â”‚  â”‚  1. GetByIdAsync(eventId, trackChanges: true)              â”‚  â”‚â”‚
â”‚  â”‚  â”‚  2. event.Cancel(reason) // Raises EventCancelledEvent     â”‚  â”‚â”‚
â”‚  â”‚  â”‚  3. _unitOfWork.CommitAsync() // â”€â”€â”€â” FAST (<1 second!) âœ… â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜  â”‚â”‚
â”‚  â”‚                                         â”‚                     â”‚    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚       EventCancelledEventHandler (REFACTORED)                â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                               â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Handle(EventCancelledEvent notification)                    â”‚ â”‚â”‚
â”‚  â”‚  â”‚  {                                                            â”‚ â”‚â”‚
â”‚  â”‚  â”‚    // Queue background job (returns immediately!)            â”‚ â”‚â”‚
â”‚  â”‚  â”‚    var jobId = _backgroundJobClient.Enqueue<                â”‚ â”‚â”‚
â”‚  â”‚  â”‚        EventCancellationEmailJob>(                           â”‚ â”‚â”‚
â”‚  â”‚  â”‚        job => job.SendCancellationEmailsAsync(               â”‚ â”‚â”‚
â”‚  â”‚  â”‚            eventId, reason, cancelledAt));                   â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                               â”‚ â”‚â”‚
â”‚  â”‚  â”‚    _logger.LogInformation(                                   â”‚ â”‚â”‚
â”‚  â”‚  â”‚        "Background job {JobId} queued", jobId);              â”‚ â”‚â”‚
â”‚  â”‚  â”‚  }                                                            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Total: <100ms âœ… INSTANT RESPONSE                           â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚                                         â”‚                          â”‚â”‚
â”‚  â”‚                                         â”‚ Queue job                â”‚â”‚
â”‚  â”‚                                         â–¼                          â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚       EventCancellationEmailJob (NEW)                        â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                               â”‚â”‚â”‚
â”‚  â”‚  â”‚  [Queue("emails")]                                           â”‚â”‚â”‚
â”‚  â”‚  â”‚  [AutomaticRetry(Attempts = 3)]                              â”‚â”‚â”‚
â”‚  â”‚  â”‚  public async Task SendCancellationEmailsAsync(              â”‚â”‚â”‚
â”‚  â”‚  â”‚      Guid eventId, string reason, DateTime cancelledAt)      â”‚â”‚â”‚
â”‚  â”‚  â”‚  {                                                            â”‚â”‚â”‚
â”‚  â”‚  â”‚    // SAME LOGIC AS PHASE 1 HANDLER                          â”‚â”‚â”‚
â”‚  â”‚  â”‚    // But runs in background worker, not API thread!         â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                               â”‚â”‚â”‚
â”‚  â”‚  â”‚    1. Load event data                         (100ms)        â”‚â”‚â”‚
â”‚  â”‚  â”‚    2. Load registrations                      (200ms)        â”‚â”‚â”‚
â”‚  â”‚  â”‚    3. âœ… BULK load user emails                (100ms)        â”‚â”‚â”‚
â”‚  â”‚  â”‚    4. Resolve email groups + newsletter     (2-3 sec)        â”‚â”‚â”‚
â”‚  â”‚  â”‚    5. For each recipient:                                    â”‚â”‚â”‚
â”‚  â”‚  â”‚         Send email                         (15-20 sec)       â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                               â”‚â”‚â”‚
â”‚  â”‚  â”‚    Total: 15-25 seconds (but user doesn't wait!)            â”‚â”‚â”‚
â”‚  â”‚  â”‚  }                                                            â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Infrastructure Layer                          â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  Hangfire                â”‚  â”‚  UserRepository               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  BackgroundJobClient     â”‚  â”‚                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                          â”‚  â”‚  GetEmailsByUserIdsAsync()    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Enqueue<T>(             â”‚  â”‚  (Bulk query from Phase 1)    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    Expression<Action<T>>)â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”‚                          â”‚                                     â”‚  â”‚
â”‚  â”‚  â”‚  Stores job in           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  PostgreSQL              â”‚  â”‚  EmailService                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                               â”‚ â”‚  â”‚
â”‚  â”‚             â”‚                   â”‚  SendTemplatedEmailAsync()    â”‚ â”‚  â”‚
â”‚  â”‚             â”‚                   â”‚  (Called by background job)   â”‚ â”‚  â”‚
â”‚  â”‚             â–¼                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚
â”‚  â”‚  â”‚  Hangfire Worker         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  (Background Service)    â”‚  â”‚  EventNotificationRecipient   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                          â”‚  â”‚  Service                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Polls job queue       â”‚  â”‚                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Executes jobs         â”‚  â”‚  ResolveRecipientsAsync()     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Retries on failure    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”‚  - Updates job state     â”‚                                     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Executes job asynchronously
                    â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  PostgreSQL Database â”‚
          â”‚                      â”‚
          â”‚  Hangfire Schema:    â”‚
          â”‚  - hangfire.job      â”‚
          â”‚  - hangfire.state    â”‚
          â”‚  - hangfire.queue    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Phase 2 Benefits:
  1. API Response Time: <1 second (95% improvement!)
  2. Scalable: Supports unlimited recipients
  3. Resilient: Automatic retry on failure (3 attempts)
  4. Observable: Hangfire dashboard shows job status
  5. No User Blocking: Emails sent asynchronously
  6. Transaction Clean: No non-critical operations in DB transaction
```

---

## Sequence Diagram - Phase 0 (Current State)

**Shows the problematic synchronous flow with N+1 queries and timeout**

```
Actor: Event Organizer
UI: Next.js Frontend
API: EventsController
Handler: CancelEventCommandHandler
UoW: UnitOfWork
EventHandler: EventCancelledEventHandler
EventRepo: EventRepository
RegRepo: RegistrationRepository
UserRepo: UserRepository (N+1)
EmailSvc: EmailService
DB: PostgreSQL

Event Organizer -> UI: Click "Cancel Event"
UI -> UI: setIsCancelling(true)
UI -> API: POST /api/events/{id}/cancel (30s timeout)
API -> Handler: Send(CancelEventCommand)

Handler -> EventRepo: GetByIdAsync(id, trackChanges: true)
EventRepo -> DB: SELECT * FROM events WHERE id = ?
DB -> EventRepo: Event data
EventRepo -> Handler: Event

Handler -> Handler: event.Cancel(reason)
note right of Handler: Status = Cancelled\nRaises EventCancelledEvent

Handler -> UoW: CommitAsync()
UoW -> DB: SaveChangesAsync()
DB -> UoW: âœ… Event saved (Status=Cancelled)

UoW -> UoW: Dispatch domain events
UoW -> EventHandler: Handle(EventCancelledEvent)

EventHandler -> EventRepo: GetByIdAsync(eventId)
EventRepo -> DB: SELECT * FROM events WHERE id = ?
DB -> EventRepo: Event data

EventHandler -> RegRepo: GetByEventAsync(eventId)
RegRepo -> DB: SELECT * FROM registrations WHERE event_id = ?
DB -> RegRepo: 50 registrations

note right of EventHandler: âŒ N+1 QUERY PATTERN STARTS

loop For each of 50 registrations
    EventHandler -> UserRepo: GetByIdAsync(registration.UserId)
    UserRepo -> DB: SELECT * FROM users WHERE id = ?
    DB -> UserRepo: User data
    EventHandler -> EventHandler: Add user.Email to list
end

note right of EventHandler: 50 separate DB queries!\n5-10 seconds wasted

EventHandler -> EventHandler: Resolve email groups (2-3s)
EventHandler -> EventHandler: Consolidate recipients (50 unique emails)

note right of EventHandler: âŒ SEQUENTIAL EMAIL SENDING STARTS

loop For each of 50 recipients
    EventHandler -> EmailSvc: SendTemplatedEmailAsync(email, params)
    EmailSvc -> EmailSvc: Build email from template
    EmailSvc -> Azure: Send via SMTP
    Azure -> EmailSvc: âœ… Sent (300ms)
end

note right of EventHandler: 50 Ã— 300ms = 15 seconds

EventHandler -> UoW: âœ… Handler completed (total: 30+ seconds)
UoW -> Handler: âœ… CommitAsync completed

note right of UI: â±ï¸ 30 SECONDS ELAPSED\nâŒ FRONTEND TIMEOUT!

UI -> UI: âŒ Axios timeout error
UI -> UI: setError("Failed to cancel event")
UI -> UI: setIsCancelling(false)
UI -> Event Organizer: âŒ Show error message

note right of Event Organizer: Event IS cancelled in DB\nBut UI shows error!\nUser retries...

Event Organizer -> UI: Click "Cancel Event" again
UI -> API: POST /api/events/{id}/cancel
Handler -> EventRepo: GetByIdAsync(id)
Handler -> Handler: event.Cancel(reason)
note right of Handler: Status already = Cancelled\nâŒ Validation fails

Handler -> API: âŒ Result.Failure("Only published or draft events can be cancelled")
API -> UI: 400 Bad Request
UI -> Event Organizer: âŒ Show validation error

note right of Event Organizer: User confused!\nRefreshes page...\nSees event is cancelled âœ“
```

---

## Sequence Diagram - Phase 1 (Hotfix)

**Shows optimized flow with bulk email query and increased timeout**

```
Actor: Event Organizer
UI: Next.js Frontend (90s timeout)
API: EventsController
Handler: CancelEventCommandHandler
UoW: UnitOfWork
EventHandler: EventCancelledEventHandler (Optimized)
UserRepo: UserRepository (Bulk)
EmailSvc: EmailService
DB: PostgreSQL

Event Organizer -> UI: Click "Cancel Event"
UI -> UI: setIsCancelling(true)
UI -> API: POST /api/events/{id}/cancel (90s timeout âœ…)
API -> Handler: Send(CancelEventCommand)

Handler -> EventRepo: GetByIdAsync(id, trackChanges: true)
EventRepo -> DB: SELECT * FROM events WHERE id = ?
DB -> EventRepo: Event data
EventRepo -> Handler: Event

Handler -> Handler: event.Cancel(reason)
note right of Handler: Status = Cancelled\nRaises EventCancelledEvent

Handler -> UoW: CommitAsync()
UoW -> DB: SaveChangesAsync()
DB -> UoW: âœ… Event saved (Status=Cancelled)

UoW -> UoW: Dispatch domain events
UoW -> EventHandler: Handle(EventCancelledEvent)
EventHandler -> EventHandler: Stopwatch.Start() â±ï¸

EventHandler -> EventRepo: GetByIdAsync(eventId)
EventRepo -> DB: SELECT * FROM events WHERE id = ?
DB -> EventRepo: Event data (100ms)

EventHandler -> RegRepo: GetByEventAsync(eventId)
RegRepo -> DB: SELECT * FROM registrations WHERE event_id = ?
DB -> RegRepo: 50 registrations (200ms)

EventHandler -> EventHandler: Extract userIds from registrations
note right of EventHandler: var userIds = registrations\n  .Select(r => r.UserId.Value)\n  .ToList();

note right of EventHandler: âœ… BULK QUERY (Phase 1 optimization)

EventHandler -> UserRepo: GetEmailsByUserIdsAsync(userIds)
UserRepo -> DB: SELECT id, email FROM users WHERE id IN (?, ?, ..., ?)
note right of DB: âœ… Single query for 50 users!
DB -> UserRepo: Dictionary<Guid, string> (50 emails)
UserRepo -> EventHandler: emailsByUserId (100ms âœ…)

note right of EventHandler: 10-20x faster than N+1!

EventHandler -> EventHandler: Resolve email groups (2-3s)
EventHandler -> EventHandler: Consolidate recipients (50 unique emails)

note right of EventHandler: Email sending still sequential\n(Phase 2 will fix this)

loop For each of 50 recipients
    EventHandler -> EmailSvc: SendTemplatedEmailAsync(email, params)
    EmailSvc -> Azure: Send via SMTP
    Azure -> EmailSvc: âœ… Sent (300ms)
end

note right of EventHandler: 50 Ã— 300ms = 15 seconds

EventHandler -> EventHandler: Stopwatch.Stop() â±ï¸
EventHandler -> EventHandler: _logger.LogInformation("Duration: 18,234ms")
EventHandler -> UoW: âœ… Handler completed (total: ~18 seconds)
UoW -> Handler: âœ… CommitAsync completed

Handler -> API: Result.Success()
API -> UI: 200 OK (total: ~19 seconds âœ…)

note right of UI: âœ… 19 SECONDS < 90s timeout

UI -> UI: âœ… Success!
UI -> UI: setShowCancelModal(false)
UI -> UI: refetch() // Get updated event state
UI -> Event Organizer: âœ… "Event cancelled successfully"

note right of Event Organizer: âœ… Success!\n10-20s faster than Phase 0\n95% success rate
```

---

## Sequence Diagram - Phase 2 (Background Jobs)

**Shows asynchronous flow with Hangfire background job processing**

```
Actor: Event Organizer
UI: Next.js Frontend (30s timeout)
API: EventsController
Handler: CancelEventCommandHandler
UoW: UnitOfWork
EventHandler: EventCancelledEventHandler (Background)
Hangfire: BackgroundJobClient
Worker: Hangfire Worker
Job: EventCancellationEmailJob
UserRepo: UserRepository (Bulk)
EmailSvc: EmailService
DB: PostgreSQL (includes Hangfire schema)

Event Organizer -> UI: Click "Cancel Event"
UI -> UI: setIsCancelling(true)
UI -> API: POST /api/events/{id}/cancel (30s timeout)
API -> Handler: Send(CancelEventCommand)

Handler -> EventRepo: GetByIdAsync(id, trackChanges: true)
EventRepo -> DB: SELECT * FROM events WHERE id = ?
DB -> EventRepo: Event data (10ms)

Handler -> Handler: event.Cancel(reason)
note right of Handler: Status = Cancelled\nRaises EventCancelledEvent

Handler -> UoW: CommitAsync()
UoW -> DB: SaveChangesAsync()
DB -> UoW: âœ… Event saved (Status=Cancelled) (200ms)

UoW -> UoW: Dispatch domain events
UoW -> EventHandler: Handle(EventCancelledEvent)

note right of EventHandler: âœ… QUEUE BACKGROUND JOB\n(Returns immediately!)

EventHandler -> Hangfire: Enqueue<EventCancellationEmailJob>(\n  job => job.SendCancellationEmailsAsync(\n    eventId, reason, cancelledAt))
Hangfire -> DB: INSERT INTO hangfire.job (...)
DB -> Hangfire: âœ… Job queued (jobId: 78910)
Hangfire -> EventHandler: jobId: 78910 (10ms âœ…)

EventHandler -> EventHandler: _logger.LogInformation(\n  "Background job {JobId} queued", jobId)
EventHandler -> UoW: âœ… Handler completed (<100ms total!)
UoW -> Handler: âœ… CommitAsync completed

Handler -> API: Result.Success()
API -> UI: 200 OK (<1 second! âœ…)

note right of UI: âœ… <1 SECOND RESPONSE!

UI -> UI: âœ… Success!
UI -> UI: setShowCancelModal(false)
UI -> UI: refetch() // Event shows Status=Cancelled
UI -> Event Organizer: âœ… "Event cancelled successfully\nNotifications being sent..."

note right of Event Organizer: âœ… Instant feedback!\nUser can continue working

note over Worker, Job: ASYNCHRONOUS PROCESSING (user doesn't wait)

Worker -> DB: SELECT * FROM hangfire.job WHERE state = 'Enqueued'
DB -> Worker: Job 78910 (EventCancellationEmailJob)
Worker -> Worker: Dequeue job 78910
Worker -> DB: UPDATE hangfire.job SET state = 'Processing'
Worker -> Job: SendCancellationEmailsAsync(eventId, reason, cancelledAt)

Job -> Job: _logger.LogInformation("EventCancellationEmailJob START")
Job -> Job: Stopwatch.Start() â±ï¸

Job -> EventRepo: GetByIdAsync(eventId)
EventRepo -> DB: SELECT * FROM events WHERE id = ?
DB -> EventRepo: Event data (100ms)

Job -> RegRepo: GetByEventAsync(eventId)
RegRepo -> DB: SELECT * FROM registrations WHERE event_id = ?
DB -> RegRepo: 50 registrations (200ms)

Job -> Job: Extract userIds from registrations

note right of Job: âœ… BULK QUERY (Phase 1 optimization)

Job -> UserRepo: GetEmailsByUserIdsAsync(userIds)
UserRepo -> DB: SELECT id, email FROM users WHERE id IN (?, ?, ...)
DB -> UserRepo: Dictionary<Guid, string> (50 emails)
UserRepo -> Job: emailsByUserId (100ms âœ…)

Job -> Job: Resolve email groups (2-3s)
Job -> Job: Consolidate recipients (50 unique emails)

loop For each of 50 recipients
    Job -> EmailSvc: SendTemplatedEmailAsync(email, params)
    EmailSvc -> Azure: Send via SMTP
    Azure -> EmailSvc: âœ… Sent (300ms)
end

note right of Job: 50 Ã— 300ms = 15 seconds\n(User doesn't wait!)

Job -> Job: Stopwatch.Stop() â±ï¸
Job -> Job: _logger.LogInformation(\n  "EventCancellationEmailJob COMPLETED\n  Recipients: 50, Success: 50, Failed: 0\n  Duration: 18,234ms")
Job -> Worker: âœ… Job completed

Worker -> DB: UPDATE hangfire.job SET state = 'Succeeded'
DB -> Worker: âœ… Updated

note right of Event Organizer: âœ… 50 cancellation emails sent\nâœ… User never waited\nâœ… Scalable to 1000+ recipients
```

---

## Deployment Diagram

**Shows Azure infrastructure for background job processing**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Azure Cloud                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Azure Static Web Apps                               â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  Next.js Frontend                                                â”‚ â”‚
â”‚  â”‚  - Event cancellation UI                                         â”‚ â”‚
â”‚  â”‚  - 90s timeout (Phase 1) â†’ 30s timeout (Phase 2)                â”‚ â”‚
â”‚  â”‚  - State management with refetch                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚                                                  â”‚
â”‚                     â”‚ HTTPS (Azure Front Door)                         â”‚
â”‚                     â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Azure Container Apps                                â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  lankaconnect-api-staging                                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  ASP.NET Core API (.NET 8)                                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - EventsController                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - CancelEventCommandHandler                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - EventCancelledEventHandler                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Hangfire Dashboard (/hangfire)                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Environment Variables:                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - ConnectionStrings__DefaultConnection                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - EmailSettings__AzureConnectionString                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Scale Configuration:                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Min replicas: 1                                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Max replicas: 3                                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - CPU: 0.5 cores                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Memory: 1 GB                                             â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                     â”‚                                            â”‚ â”‚
â”‚  â”‚                     â”‚ Runs in same container                     â”‚ â”‚
â”‚  â”‚                     â–¼                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Hangfire Background Worker                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  BackgroundJobServer (Hosted Service)                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Worker count: 1                                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Queues: ["emails", "default"]                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Poll interval: 15 seconds                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Jobs:                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - EventCancellationEmailJob (NEW in Phase 2)              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - EventReminderJob (Existing)                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - EventStatusUpdateJob (Existing)                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - ExpiredBadgeCleanupJob (Existing)                        â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚                                                  â”‚
â”‚                     â”‚ SQL Connection (SSL)                             â”‚
â”‚                     â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Azure Database for PostgreSQL                       â”‚ â”‚
â”‚  â”‚              (Flexible Server)                                   â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  Database: LankaConnectDB                                        â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  Schemas:                                                        â”‚ â”‚
â”‚  â”‚  - public (application tables)                                   â”‚ â”‚
â”‚  â”‚    - events                                                      â”‚ â”‚
â”‚  â”‚    - registrations                                               â”‚ â”‚
â”‚  â”‚    - users                                                       â”‚ â”‚
â”‚  â”‚    - email_messages                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  - hangfire (background jobs)                                    â”‚ â”‚
â”‚  â”‚    - hangfire.job                                                â”‚ â”‚
â”‚  â”‚    - hangfire.state                                              â”‚ â”‚
â”‚  â”‚    - hangfire.jobparameter                                       â”‚ â”‚
â”‚  â”‚    - hangfire.jobqueue                                           â”‚ â”‚
â”‚  â”‚    - hangfire.server                                             â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  Performance:                                                    â”‚ â”‚
â”‚  â”‚  - Tier: Burstable B2s (2 vCores, 4 GB RAM)                     â”‚ â”‚
â”‚  â”‚  - Storage: 128 GB                                               â”‚ â”‚
â”‚  â”‚  - Backup retention: 7 days                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Azure Communication Services                        â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  Email Service                                                   â”‚ â”‚
â”‚  â”‚  - SMTP relay                                                    â”‚ â”‚
â”‚  â”‚  - From: DoNotReply@lankaconnect.com                             â”‚ â”‚
â”‚  â”‚  - Rate limit: 100 emails/minute                                 â”‚ â”‚
â”‚  â”‚  - Retry handling: Built-in                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Monitoring & Observability:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hangfire Dashboard: /hangfire                                         â”‚
â”‚  - View queued jobs                                                    â”‚
â”‚  - Monitor processing jobs                                             â”‚
â”‚  - Retry failed jobs                                                   â”‚
â”‚  - View job execution history                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Structured Logging (Serilog)                                          â”‚
â”‚  - Console output                                                      â”‚
â”‚  - File logs (rolled daily)                                            â”‚
â”‚  - Seq (optional, development)                                         â”‚
â”‚  - Log enrichment: CorrelationId, UserId, Duration                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Scaling Strategy (Future):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Option 1: Vertical Scaling (Phase 2A)                                 â”‚
â”‚  - Increase Container Apps instance size                               â”‚
â”‚  - Increase Hangfire worker count (1 â†’ 5)                              â”‚
â”‚  - Handles up to 10,000 recipients/hour                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Option 2: Horizontal Scaling (Phase 2B - if needed)                   â”‚
â”‚  - Deploy dedicated Hangfire worker container                          â”‚
â”‚  - Separate API container from worker container                        â”‚
â”‚  - Independent scaling: API (3 replicas) + Worker (2 replicas)         â”‚
â”‚  - Handles unlimited recipients                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

These C4 diagrams provide multiple levels of architectural detail:

**Level 1 - System Context**: Shows external actors and systems
**Level 2 - Container**: Shows applications and data stores
**Level 3 - Component**: Shows internal components and their interactions across 3 phases
**Sequence Diagrams**: Show detailed interaction flows for each phase
**Deployment Diagram**: Shows Azure infrastructure and scaling strategy

**Key Takeaways**:

1. **Phase 0 Problem**: N+1 queries + synchronous email sending = 30-45 second timeout
2. **Phase 1 Solution**: Bulk query optimization = 15-25 seconds (95% success rate)
3. **Phase 2 Solution**: Background job processing = <1 second response time (unlimited scale)

All diagrams follow **C4 model conventions** and provide clear **visual representation** of the architecture before, during, and after the fixes.