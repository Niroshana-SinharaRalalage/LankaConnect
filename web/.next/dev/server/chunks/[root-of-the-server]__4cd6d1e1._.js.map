{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Work/LankaConnect/web/src/app/api/proxy/%5B...path%5D/route.ts"],"sourcesContent":["/**\n * Next.js API Route Proxy for Staging Backend\n *\n * Purpose: Forward API requests from localhost:3000 to Azure staging backend\n *\n * Why needed:\n * - Frontend: http://localhost:3000 (HTTP)\n * - Backend: https://staging.azurecontainerapps.io (HTTPS)\n * - Browsers block Secure cookies from being sent over HTTP\n * - This proxy makes browser see same-origin (localhost:3000/api/proxy/...)\n *\n * How it works:\n * - Browser sends request to localhost:3000/api/proxy/Auth/login (same-origin HTTP)\n * - Next.js server forwards to staging backend over HTTPS (server-to-server, no browser restrictions)\n * - Backend sets Secure cookies in response\n * - Next.js server receives them and forwards to browser\n * - Browser stores cookies under localhost:3000 domain\n * - Subsequent requests include cookies (same-origin)\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\n\n// IMPORTANT: Use explicit staging URL, NOT NEXT_PUBLIC_API_URL (which points to /api/proxy)\nconst BACKEND_URL = 'https://lankaconnect-api-staging.politebay-79d6e8a2.eastus2.azurecontainerapps.io/api';\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ path: string[] }> }\n) {\n  const resolvedParams = await params;\n  return forwardRequest(request, resolvedParams.path, 'GET');\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ path: string[] }> }\n) {\n  const resolvedParams = await params;\n  return forwardRequest(request, resolvedParams.path, 'POST');\n}\n\nexport async function PUT(\n  request: NextRequest,\n  { params }: { params: Promise<{ path: string[] }> }\n) {\n  const resolvedParams = await params;\n  return forwardRequest(request, resolvedParams.path, 'PUT');\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ path: string[] }> }\n) {\n  const resolvedParams = await params;\n  return forwardRequest(request, resolvedParams.path, 'DELETE');\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ path: string[] }> }\n) {\n  const resolvedParams = await params;\n  return forwardRequest(request, resolvedParams.path, 'PATCH');\n}\n\nasync function forwardRequest(\n  request: NextRequest,\n  pathSegments: string[],\n  method: string\n) {\n  try {\n    const path = pathSegments.join('/');\n    const targetUrl = `${BACKEND_URL}/${path}`;\n\n    // Get request body if present\n    let body: string | undefined;\n    if (method !== 'GET' && method !== 'DELETE') {\n      try {\n        body = await request.text();\n      } catch {\n        body = undefined;\n      }\n    }\n\n    // Forward cookies from request\n    const cookies = request.cookies.getAll();\n    const cookieHeader = cookies.map(c => `${c.name}=${c.value}`).join('; ');\n\n    // Build headers for backend request\n    const headers: HeadersInit = {\n      'Content-Type': request.headers.get('content-type') || 'application/json',\n      'Accept': request.headers.get('accept') || 'application/json',\n    };\n\n    // Forward Authorization header if present\n    const authHeader = request.headers.get('authorization');\n    if (authHeader) {\n      headers['Authorization'] = authHeader;\n    }\n\n    // Forward cookies\n    if (cookieHeader) {\n      headers['Cookie'] = cookieHeader;\n    }\n\n    console.log(`[Proxy] ${method} ${targetUrl}`);\n\n    // Make request to backend\n    const response = await fetch(targetUrl, {\n      method,\n      headers,\n      body,\n      credentials: 'include', // Important: include cookies\n    });\n\n    // Get response body\n    const responseText = await response.text();\n    let responseBody: any;\n    try {\n      responseBody = JSON.parse(responseText);\n    } catch {\n      responseBody = responseText;\n    }\n\n    // Create Next.js response\n    const nextResponse = new NextResponse(JSON.stringify(responseBody), {\n      status: response.status,\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    });\n\n    // Forward Set-Cookie headers from backend\n    const setCookieHeaders = response.headers.getSetCookie?.() || [];\n    setCookieHeaders.forEach(cookie => {\n      // Parse cookie and convert Secure/SameSite for localhost\n      const cookieParts = cookie.split(';').map(p => p.trim());\n      const [nameValue, ...attributes] = cookieParts;\n\n      // Rebuild cookie without Secure flag for localhost\n      const newAttributes = attributes\n        .filter(attr => !attr.toLowerCase().startsWith('secure'))\n        .filter(attr => !attr.toLowerCase().startsWith('samesite=none'));\n\n      // Add SameSite=Lax for localhost\n      newAttributes.push('SameSite=Lax');\n      newAttributes.push('Path=/');\n\n      const newCookie = [nameValue, ...newAttributes].join('; ');\n      nextResponse.headers.append('Set-Cookie', newCookie);\n    });\n\n    return nextResponse;\n  } catch (error) {\n    console.error('[Proxy] Error:', error);\n    return NextResponse.json(\n      { error: 'Proxy error', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}